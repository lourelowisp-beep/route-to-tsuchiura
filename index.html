<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>検索</title>
  <!-- iPhone ホーム追加（任意）-->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="検索">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b0c10">
  <link rel="apple-touch-icon" href="icon-180.png">
  <style>
    :root {
      --bg:#0b0c10; --card:#111218; --ink:#eaeaea; --muted:#a9b0b8; --accent:#4dd0e1;
      /* 路線カラー（JR目安色に寄せる） */
      --sobu:#ffd400;        /* 総武各停：黄 */
      --musashino:#ff7a00;   /* 武蔵野：橙 */
      --joban-local:#00b261; /* 常磐各停：エメラルド */
      --joban-rapid:#0099cc; /* 常磐快速：青 */
    }
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;color:var(--ink);background:linear-gradient(180deg,#0d1117,#0b0c10 40%)}
    .wrap{max-width:880px;margin:20px auto 80px;padding:0 16px env(safe-area-inset-bottom)}
    .card{background:var(--card);border:1px solid #22252e;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:none;border-radius:12px;padding:14px 16px;font-weight:700;background:#1b2532;color:var(--ink);cursor:pointer;transition:background .2s, transform .04s}
    .btn:hover{background:#233041}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,#3fb7c4,#2ea6ba);color:#071216}
    .btn.ghost{background:transparent;border:1px solid #2a2f3a}
    .section-title{font-size:14px;color:var(--muted);margin:18px 0 6px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input[type="text"]{width:100%;box-sizing:border-box;padding:14px;border-radius:12px;border:1px solid #2a2f3a;background:#0f1218;color:var(--ink);font-size:16px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{appearance:none;border:1px solid #2a2f3a;background:#0f1218;color:var(--ink);border-radius:9999px;padding:8px 12px;font-size:14px;cursor:pointer}
    .chip:active{transform:translateY(1px)}
    /* 路線チャンク */
    .line-group{margin:12px 0 6px;border:1px solid #1f2631;border-radius:14px;padding:10px;background:#0f1218}
    .line-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .lh{font-weight:700;font-size:14px;color:#c9d1d9}
    /* 路線別色 */
    .clr-sobu .dot{background:var(--sobu)}
    .clr-musashino .dot{background:var(--musashino)}
    .clr-joban-local .dot{background:var(--joban-local)}
    .clr-joban-rapid .dot{background:var(--joban-rapid)}
    .chip.sobu{border-color:color-mix(in oklab, var(--sobu) 40%, #2a2f3a);}
    .chip.musashino{border-color:color-mix(in oklab, var(--musashino) 40%, #2a2f3a);}
    .chip.joban-local{border-color:color-mix(in oklab, var(--joban-local) 40%, #2a2f3a);}
    .chip.joban-rapid{border-color:color-mix(in oklab, var(--joban-rapid) 40%, #2a2f3a);}
    /* フッター操作 */
    .footer-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-start;margin-top:18px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- 1) 一番上：検索ボタン（シンプル） -->
      <div class="row" style="justify-content:flex-start; margin-bottom:6px;">
        <button class="btn primary" id="doSearch">検索</button>
      </div>

      <!-- 2) その下：関東の運行情報ボタン -->
      <div class="row" style="margin-bottom:8px;">
        <a class="btn" id="openArea" href="https://transit.yahoo.co.jp/diainfo/area/4" target="_blank" rel="noopener">関東の運行情報</a>
      </div>

      <!-- 3) 出発地フォーム（最後に配置：シンプル） -->
      <form id="searchForm" action="#" method="get" style="margin-top:4px;">
        <label>出発地</label>
        <input id="from" type="text" value="千葉" placeholder="例：千葉／西千葉／船橋法典／柏駅 など"
               autocomplete="on" autocapitalize="off" autocorrect="off" spellcheck="false"
               inputmode="search" enterkeyhint="go" />
      </form>

      <!-- 4) 路線別プリセット（色分け） -->
      <div class="section-title">路線から選ぶ</div>

      <div class="line-group clr-sobu">
        <div class="line-head"><span class="dot"></span><span class="lh">総武線（千葉 → 西船橋）</span></div>
        <div class="chips" id="chips-sobu"></div>
      </div>

      <div class="line-group clr-musashino">
        <div class="line-head"><span class="dot"></span><span class="lh">武蔵野線（西船橋 → 新松戸）</span></div>
        <div class="chips" id="chips-musa"></div>
      </div>

      <div class="line-group clr-joban-local">
        <div class="line-head"><span class="dot"></span><span class="lh">常磐線（新松戸 → 土浦）</span></div>
        <div class="chips" id="chips-joban"></div>
      </div>

      <!-- 5) 最下部：更新ボタン（キャッシュバスター付き再読み込み） -->
      <div class="footer-actions">
        <button class="btn ghost" id="refreshBtn">更新</button>
      </div>

    </div>
  </div>

  <script>
    const $ = (s, p=document) => p.querySelector(s);

    // ===== ルール固定 =====
    const HOME_STATION = '土浦';
    const FIXED = { type: '1', sort: '0', ticket: 'ic', ws: '1' }; // 出発 / 到着早い順 / IC / 歩く急いで

    function pad2(n){ return (n<10?'0':'') + n; }
    function stationize(q){
      const s = (q||'').trim();
      if(!s) return s;
      if(/[県都府市区町村]|丁目|番地|タワー|空港|大学|病院|学校|神社|寺|公園|港|SA|PA|IC|JCT|インター/.test(s)) return s; // 住所/POIはそのまま
      return /駅$/.test(s) ? s : (s + '駅');
    }

    // ===== 経由判定（テキストだけで即決） =====
    // 区間：総武（千葉→西船橋）→武蔵野（西船橋→新松戸）→常磐（新松戸→土浦）
    const SOBU_SEG = [
      '千葉','西千葉','稲毛','新検見川','幕張','幕張本郷','津田沼','東船橋','船橋','西船橋'
    ];
    const MUSA_SEG = [
      '西船橋','船橋法典','市川大野','東松戸','新八柱','新松戸'
    ];
    const JOBAN_SEG = [
      '新松戸','北小金','南柏','柏','北柏','我孫子','天王台','取手','藤代','佐貫','牛久','ひたち野うしく','荒川沖','土浦'
    ];

    function decideViasText(fromRaw){
      const name = (fromRaw||'').replace(/駅$/,'').trim();
      if(!name) return [];
      if (SOBU_SEG.includes(name)) return ['西船橋','新松戸'];
      if (MUSA_SEG.includes(name)) return ['新松戸'];
      // JOBAN_SEG やそれ以外は経由なし
      return [];
    }

    // ===== URL生成（Yahoo!路線） =====
    function buildYahooUrl(fromRaw){
      const to = HOME_STATION;
      const vias = decideViasText(fromRaw).map(stationize);
      const d = new Date();
      const base = 'https://transit.yahoo.co.jp/search/result?';
      const params = [
        'from=' + encodeURIComponent(stationize(fromRaw)),
        'to='   + encodeURIComponent(stationize(to)),
        'y=' + d.getFullYear(),
        'm=' + pad2(d.getMonth()+1),
        'd=' + pad2(d.getDate()),
        'hh=' + pad2(d.getHours()),
        'm1=' + pad2(d.getMinutes())[0],
        'm2=' + pad2(d.getMinutes())[1],
        'type=' + FIXED.type,
        's=' + FIXED.sort,
        'ticket=' + FIXED.ticket,
        'ws=' + FIXED.ws
      ];
      vias.forEach(v => params.push('via=' + encodeURIComponent(v)));
      return base + params.join('&');
    }

    function handleSubmit(e){
      if(e) e.preventDefault();
      const fromRaw = ($('#from').value || '').trim();
      if(!fromRaw){ alert('出発地を入力してください'); return; }
      const url = buildYahooUrl(fromRaw);
      window.location.href = url; // 同一タブ遷移
    }

    // ===== プリセット描画 =====
    function makeChips(containerId, names, cls){
      const box = document.getElementById(containerId);
      if(!box) return;
      box.innerHTML = '';
      names.forEach(name=>{
        const b = document.createElement('button');
        b.type = 'button'; b.className = 'chip ' + (cls||'');
        b.textContent = name;
        b.addEventListener('click', ()=>{
          const f = document.getElementById('from');
          f.value = name; f.focus({preventScroll:true});
        });
        box.appendChild(b);
      });
    }

    // ===== 更新（キャッシュバスター付き） =====
    function refreshWithBuster(){
      const u = new URL(location.href);
      u.searchParams.set('v', Date.now());
      location.href = u.toString();
    }

    // 初期化
    window.addEventListener('DOMContentLoaded', ()=>{
      // 検索ボタン → 送信
      $('#doSearch').addEventListener('click', handleSubmit);
      $('#searchForm').addEventListener('submit', handleSubmit);
      $('#from').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.isComposing){ e.preventDefault(); handleSubmit(); } });

      makeChips('chips-sobu',  SOBU_SEG, 'sobu');
      makeChips('chips-musa',  MUSA_SEG, 'musashino');
      makeChips('chips-joban', JOBAN_SEG, 'joban-local');

      // 更新ボタン
      $('#refreshBtn').addEventListener('click', refreshWithBuster);
    });
  </script>
</body>
</html>
